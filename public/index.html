<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Gestor de colecci√≥n profesional para Pok√©mon TCG Pocket">
    <meta name="theme-color" content="#050505">
    
    <title>PokeTrader TCG Pocket | V1.0</title>
    
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="https://upload.wikimedia.org/wikipedia/commons/5/53/Pok%C3%A9_Ball_icon.svg">
    <link rel="icon" type="image/svg+xml" href="https://upload.wikimedia.org/wikipedia/commons/5/53/Pok%C3%A9_Ball_icon.svg">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Outfit:wght@400;700;800;900&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/core.css"> 
    <link rel="stylesheet" href="css/mobile.css" media="(max-width: 900px)">
    
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src="js/app_bundle.js"></script>
    <script type="module" src="js/main.js"></script>

</head>

<body x-data="pokeApp" :data-theme="currentTheme" @scroll.window="handleScroll" @click="closeContextMenu" x-cloak>

    <div id="loading-screen" x-show="isLoading" x-transition.opacity.duration.500ms>
        <div class="loader"></div>
        <div class="loading-text">Cargando Sistema...</div>
    </div>

    <div class="pin-pad-overlay" x-show="showPinPad" x-transition.opacity x-cloak>
        <div class="pin-display" x-text="'*'.repeat(pinInput.length)"></div>
        <div class="pin-grid">
            <template x-for="num in [1,2,3,4,5,6,7,8,9]">
                <button class="pin-btn" x-text="num" @click="handlePinInput(num)"></button>
            </template>
            <button class="pin-btn clear" @click="clearPin">C</button>
            <button class="pin-btn" @click="handlePinInput(0)">0</button>
            <button class="pin-btn clear" @click="closePinPad">‚úñ</button>
        </div>
        <div style="margin-top:30px; color:rgba(255,255,255,0.5); font-family:var(--font-mono);">Introduce tu PIN</div>
    </div>

    <div id="login-screen" x-show="!currentUser && !isLoading" x-transition.opacity.duration.500ms>
        <div class="login-container">
            <img src="https://upload.wikimedia.org/wikipedia/commons/9/98/International_Pok%C3%A9mon_logo.svg" 
                 alt="Logo Pok√©mon TCG" 
                 class="login-logo">
            
            <h1 class="login-title">Seleccionar Perfil</h1>
            
            <div class="profiles-grid">
                <template x-for="acc in accounts" :key="acc.id_cuenta">
                    <div class="profile-card" @click="selectUserForLogin(acc)">
                        <div class="avatar-circle" :style="acc.avatar_img ? `background-image:url(${acc.avatar_img});` : ''">
                            <span x-show="!acc.avatar_img">üë§</span>
                        </div>
                        <h3 x-text="acc.nombre"></h3>
                        <small x-text="acc.tipo"></small>
                        <div style="margin-top:10px; font-size:0.7rem; opacity:0.6;" x-show="acc.ultima_conexion">
                            Visto: <span x-text="isNew(acc.ultima_conexion) ? 'Hoy' : 'Hace d√≠as'"></span>
                        </div>
                    </div>
                </template>
                <div class="profile-card add-user-card" @click="openCreateUserModal()">
                    <div class="avatar-circle"><span>+</span></div>
                    <h3>Nuevo</h3>
                    <small>Crear Cuenta</small>
                </div>
            </div>
            
            <div id="login-modal" class="hidden" style="margin-top: 20px;">
                 <div id="login-form" class="hidden">
                     </div>
                 
                 <div id="register-form" class="hidden" style="background:rgba(0,0,0,0.5); padding:15px; border-radius:10px;">
                     <h3 style="margin-bottom:10px;">Crear Nueva Cuenta</h3>
                     <input type="text" id="reg-username" placeholder="Tu Nombre..." style="width:100%; margin-bottom:10px; padding:10px; border-radius:5px;">
                     <input type="password" id="reg-password" placeholder="Elige un PIN..." style="width:100%; margin-bottom:10px; padding:10px; border-radius:5px;">
                     <div style="display:flex; gap:10px;">
                         <button class="btn-outline" onclick="document.getElementById('login-modal').classList.add('hidden')" style="flex:1;">Cancelar</button>
                         <button class="btn-save" onclick="registerNewUser()" style="flex:1;">Crear</button>
                     </div>
                 </div>
            </div>

        </div>
    </div>

    <div id="app-container" x-show="currentUser" x-cloak>
        
        <div id="menu-overlay" class="mobile-sidebar-overlay" :class="{'active': showMobileSidebar}" @click="toggleMobileSidebar()"></div>

        <button class="menu-trigger" @click="toggleMobileSidebar()">‚ò∞</button>

        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="user-profile">
                    <div class="avatar-circle" 
                         :style="currentUser?.avatar_img ? `background-image:url(${currentUser.avatar_img});` : ''" 
                         @click="openSettings" 
                         title="Configuraci√≥n de Perfil">
                        <span x-show="!currentUser?.avatar_img">üë§</span>
                    </div>
                    <h3 x-text="currentUser?.nombre"></h3>
                    <span x-text="currentUser?.tipo"></span>
                </div>
            </div>
            
            <div class="sidebar-content">
                <div class="nav-section expansion-selector">
                    <label>Colecci√≥n Activa</label>
                    <div style="text-align:center; min-height:100px; display:flex; align-items:center; justify-content:center; margin-bottom:15px;">
                        <img :src="mediaManager.loadSetLogo(currentExp)" x-show="currentExp !== 'TODAS' && mediaManager.loadSetLogo(currentExp)" alt="Logo Set">
                        <span x-show="currentExp === 'TODAS'" style="font-size: 4rem;">üåç</span>
                    </div>
                    <select x-model="currentExp" @change="changeExpansion" class="image-ready-select">
                        <option value="TODAS">TODAS LAS COLECCIONES</option>
                        <template x-for="e in expansiones">
                            <option x-text="e" :value="e"></option>
                        </template>
                    </select>
                </div>
                
                <div class="nav-section">
                    <label>Wishlist R√°pida ‚ù§Ô∏è</label>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <template x-for="w in wishlist" :key="w.id_carta + w.expansion">
                            <div class="wishlist-sidebar-item" @click="filters.search = w.nombre; tab='grid'; loadInventory()">
                                <div>
                                    <div class="wishlist-name" x-text="w.nombre"></div>
                                    <div class="wishlist-exp" x-text="w.expansion"></div>
                                </div>
                                <span style="font-size:1.2rem; opacity:0.7;">üëâ</span>
                            </div>
                        </template>
                        <div x-show="wishlist.length === 0" style="color:var(--text-muted); font-size:0.85em; text-align:center; padding:20px 0; font-style:italic; border:1px dashed var(--border-color); border-radius:12px;">
                            No tienes favoritos.<br>Usa el ‚ù§Ô∏è en las cartas.
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <button @click="logout" class="btn-logout">üö™ Cerrar Sesi√≥n</button>
            </div>
        </aside>

        <div id="side-menu" class="mobile-sidebar" :class="{'open': showMobileSidebar}">
            <div class="sidebar-header">
                <div class="user-profile">
                    <div class="avatar-circle" :style="currentUser?.avatar_img ? `background-image:url(${currentUser.avatar_img});` : ''"></div>
                    <h3 x-text="currentUser?.nombre"></h3>
                    <small>Men√∫ Principal</small>
                </div>
            </div>
            <div class="sidebar-content">
                <button class="btn-outline" @click="openSettings(); toggleMobileSidebar()" style="width:100%; margin-bottom:20px;">‚öôÔ∏è Configuraci√≥n</button>
                <h4 style="color:var(--text-muted); margin-bottom:10px;">Colecci√≥n</h4>
                <select x-model="currentExp" @change="changeExpansion(); toggleMobileSidebar()" style="width:100%; margin-bottom:20px;">
                    <option value="TODAS">TODAS LAS COLECCIONES</option>
                    <template x-for="e in expansiones"><option x-text="e" :value="e"></option></template>
                </select>
                <h4 style="color:var(--text-muted); margin-bottom:10px;">Wishlist</h4>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <template x-for="w in wishlist">
                        <div class="wishlist-sidebar-item" @click="filters.search = w.nombre; tab='grid'; loadInventory(); toggleMobileSidebar()">
                            <span x-text="w.nombre" style="font-weight:700;"></span>
                            <span x-text="w.expansion" style="font-size:0.8rem; color:var(--text-muted);"></span>
                        </div>
                    </template>
                </div>
            </div>
            <div class="sidebar-footer">
                <button class="btn-danger" @click="logout" style="width:100%;">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <main class="main-content">
            
            <nav class="top-nav">
                <button class="tab-btn" :class="{'active': tab==='info'}" @click="switchTab('info')">üìä Dashboard</button>
                <button class="tab-btn" :class="{'active': tab==='grid' && section==='Normal'}" @click="switchTab('grid', 'Normal')">üÉè Normales</button>
                <button class="tab-btn" :class="{'active': tab==='grid' && section==='Especial'}" @click="switchTab('grid', 'Especial')">‚ú® Especiales</button>
                <button class="tab-btn" :class="{'active': tab==='social'}" @click="switchTab('social')">‚ù§Ô∏è Social</button>
                <button class="tab-btn" :class="{'active': tab==='history'}" @click="tab='history'; loadHistory()">üìú Historial</button>
                <button class="tab-btn" x-show="isAdmin" :class="{'active': tab==='admin'}" @click="tab='admin'" style="color:var(--danger); border-color:var(--danger); margin-left:auto;">‚öôÔ∏è Admin</button>
                
                <div class="relative cursor-pointer mr-4 ml-4" @click="showNotifications = !showNotifications; markRead()">
                    <span class="text-2xl">üîî</span>
                    <span x-show="unreadNotif > 0" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center" x-text="unreadNotif"></span>
                    
                    <div x-show="showNotifications" @click.away="showNotifications = false" class="absolute right-0 mt-2 w-72 bg-gray-900 border border-gray-600 rounded shadow-xl z-50 p-0 overflow-hidden" style="max-height:300px; overflow-y:auto;">
                        <template x-for="n in notifications" :key="n.id_notificacion">
                            <div class="text-sm p-3 border-b border-gray-700 text-gray-300 hover:bg-gray-800 transition">
                                <p x-text="n.mensaje"></p>
                                <small class="text-gray-500 block mt-1" x-text="getTimeString(n.fecha)"></small>
                            </div>
                        </template>
                        <div x-show="notifications.length === 0" class="text-center p-4 text-gray-500 italic">Sin novedades recientes</div>
                    </div>
                </div>
            </nav>

            <div x-show="tab==='info'" class="tab-pane fade-in-up">
                
                <div style="text-align:right; margin-bottom:20px;" class="desktop-only">
                    <button class="btn-outline" style="height:35px; padding:0 15px; font-size:0.8rem;" @click="zenMode = !zenMode" x-text="zenMode ? 'üëÅÔ∏è Ver Widgets' : 'üßò Modo Zen'"></button>
                </div>

                <div style="display:flex; gap:35px; flex-wrap:wrap; margin-bottom:35px;">
                    
                    <div class="card-panel" style="flex:1; min-width:350px;">
                        <h3>üéí Mochila del Entrenador</h3>
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap:15px; margin-bottom:25px;">
                            <div style="background:var(--bg-input); padding:15px; border-radius:16px; text-align:center; border:1px solid var(--border-color);">
                                <div style="font-size:2rem;">üåà</div>
                                <input type="number" x-model.number="currentUser.polvos_iris" 
                                       style="width:100%; background:transparent; border:none; text-align:center; font-weight:900; color:var(--text-light); font-size:1.4rem; padding:0; height:auto; margin:5px 0;">
                                <div style="font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; font-weight:700;">Polvos</div>
                            </div>
                            <div style="background:var(--bg-input); padding:15px; border-radius:16px; text-align:center; border:1px solid var(--border-color);">
                                <div style="font-size:2rem;">üé´</div>
                                <input type="number" x-model.number="currentUser.fichas_cambio" 
                                       style="width:100%; background:transparent; border:none; text-align:center; font-weight:900; color:var(--text-light); font-size:1.4rem; padding:0; height:auto; margin:5px 0;">
                                <div style="font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; font-weight:700;">Fichas</div>
                            </div>
                            <div style="background:var(--bg-input); padding:15px; border-radius:16px; text-align:center; border:1px solid var(--border-color);">
                                <div style="font-size:2rem;">‚è≥</div>
                                <input type="number" x-model.number="currentUser.relojes_arena" 
                                       style="width:100%; background:transparent; border:none; text-align:center; font-weight:900; color:var(--text-light); font-size:1.4rem; padding:0; height:auto; margin:5px 0;">
                                <div style="font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; font-weight:700;">Relojes</div>
                            </div>
                        </div>
                        
                        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-bottom:20px; display:flex; align-items:center; gap:15px;" :class="{'zen-hidden': zenMode}">
                            <div style="font-size:1.5rem;">üì¶</div>
                            <div>
                                <div style="font-weight:700; color:var(--text-light)">Apertura Disponible</div>
                                <div style="font-size:0.85rem; color:var(--text-muted)">Puedes abrir <b x-text="openingPotential" style="color:var(--accent-primary)"></b> sobres ahora mismo.</div>
                            </div>
                        </div>

                        <div style="margin-bottom:20px;">
                            <label style="font-size:0.85rem; color:var(--text-muted); font-weight:bold; text-transform:uppercase; margin-bottom:10px; display:block;">Notas</label>
                            <input type="text" x-model="currentUser.notas" placeholder="Ej: Buscando Mewtwo..." style="background:rgba(0,0,0,0.2);">
                        </div>
                        <button class="btn-save" style="width:100%" @click="saveResourcesOnly">üíæ Guardar Cambios</button>
                    </div>

                    <div class="card-panel" style="flex:1.5; min-width:350px;" :class="{'zen-hidden': zenMode}">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3>üèÜ Hall de la Fama</h3>
                            <div style="text-align:right;">
                                <div style="font-size:0.8rem; color:var(--text-muted); text-transform:uppercase;">Valor Colecci√≥n</div>
                                <div style="font-size:1.4rem; font-weight:900; color:var(--gold);" x-text="new Intl.NumberFormat().format(netWorth)"></div>
                            </div>
                        </div>
                        
                        <div x-show="topCards.length === 0" style="text-align:center; padding:40px; color:var(--text-muted); font-style:italic;">
                            A√∫n no tienes cartas destacadas.
                        </div>
                        
                        <div class="hall-of-fame-grid" x-show="topCards.length > 0">
                            <template x-for="(card, index) in topCards" :key="card.id_carta">
                                <div class="hof-card">
                                    <div class="hof-rank" x-text="'#' + (index + 1)"></div>
                                    <img :src="mediaManager.loadImage(card)" loading="lazy">
                                    <div style="font-weight:800; color:var(--text-light); font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" x-text="card.nombre"></div>
                                    <div style="font-size:0.75rem; color:var(--gold); text-transform:uppercase; margin-top:4px;" x-text="card.rareza"></div>
                                </div>
                            </template>
                        </div>

                        <div class="nemesis-card" x-show="nemesis" style="margin-top:20px;">
                            <div class="nemesis-avatar" :style="nemesis?.avatar_img ? `background-image:url(${nemesis.avatar_img})` : 'background-color:#333'"></div>
                            <div>
                                <div style="color:var(--danger); font-weight:800; font-size:0.8rem; text-transform:uppercase;" x-text="nemesis?.isLeader ? 'TOP 1 GLOBAL' : 'TU RIVAL'"></div>
                                <div style="font-size:1.4rem; font-weight:900; color:var(--text-light)" x-text="nemesis?.nombre"></div>
                                <div style="font-size:0.9rem; color:var(--text-muted)" x-text="nemesis?.isLeader ? '¬°Eres el mejor!' : 'Te saca ' + nemesis?.diff + ' cartas de ventaja'"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display:flex; gap:35px; flex-wrap:wrap;" :class="{'zen-hidden': zenMode}">
                    
                    <div class="card-panel" style="flex:1; min-width:300px; display:flex; flex-direction:column; align-items:center;">
                        <h3 style="width:100%">üìä Rarezas</h3>
                        <div style="height:250px; width:100%; position:relative;">
                            <canvas id="rarityChart"></canvas>
                        </div>
                    </div>

                    <div class="card-panel" style="flex:1.5; min-width:350px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                            <h3 style="margin:0;">üìà Progreso</h3>
                            <div class="toggle-pill">
                                <div class="toggle-option" :class="{'active': !showSecrets}" @click="showSecrets=false">Normal</div>
                                <div class="toggle-option" :class="{'active': showSecrets}" @click="showSecrets=true">Full</div>
                            </div>
                        </div>
                        
                        <div x-show="bestExpansion" style="margin-bottom:20px; background:var(--bg-input); padding:15px; border-radius:12px; border:1px solid var(--success);">
                            <div style="font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; font-weight:bold;">A un paso de la gloria</div>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-weight:900; font-size:1.1rem; color:var(--success);" x-text="bestExpansion?.name"></div>
                                <div style="font-weight:900;" x-text="bestExpansion?.pct + '%'"></div>
                            </div>
                        </div>

                        <div style="margin-bottom:30px; background:rgba(255,255,255,0.05); padding:15px; border-radius:16px;">
                            <div class="exp-progress-label">
                                <span style="color:var(--text-light)">TOTAL GLOBAL</span>
                                <span>
                                    <span x-text="computedProgress.owned + ' / ' + computedProgress.total"></span>
                                    (<span x-text="computedProgress.pct + '%'"></span>)
                                </span>
                            </div>
                            <div class="exp-progress-track">
                                <div class="exp-progress-bar" :style="`width: ${computedProgress.pct}%`"></div>
                            </div>
                        </div>

                        <div style="max-height:200px; overflow-y:auto; padding-right:10px;">
                            <template x-for="exp in expansionStats" :key="exp.name">
                                <div class="exp-progress-row">
                                    <div class="exp-progress-label">
                                        <span x-text="exp.name"></span>
                                        <span><span x-text="exp.owned"></span>/<span x-text="exp.total"></span> (<span x-text="exp.pct + '%'"></span>)</span>
                                    </div>
                                    <div class="exp-progress-track">
                                        <div class="exp-progress-bar" :style="`width: ${exp.pct}%; background-color: ${exp.pct == 100 ? 'var(--success)' : 'var(--accent-primary)'}`"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <div class="card-panel" style="margin-top:35px; max-height:200px; overflow-y:auto; background:var(--bg-panel);" x-show="!zenMode">
                    <h3 style="font-size:0.9rem; color:var(--text-muted); margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:5px;">üì∞ FEED DEL SERVIDOR</h3>
                    <template x-for="act in globalFeed">
                        <div style="font-size:0.85rem; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; align-items:center; gap:10px;">
                            <div class="avatar-circle" :style="act.avatar_img ? `background-image:url(${act.avatar_img})` : ''" style="width:25px; height:25px; border:none; font-size:12px;"></div>
                            <div>
                                <span style="font-weight:bold; color:var(--accent-primary);" x-text="act.usuario"></span>
                                <span x-text="act.mensaje" style="color:var(--text-light)"></span>
                                <span style="color:var(--text-muted); font-size:0.75rem; margin-left:5px;" x-text="getTimeString(act.fecha)"></span>
                            </div>
                        </div>
                    </template>
                </div>

            </div>

            <div x-show="tab==='grid'" class="tab-pane fade-in-up">
                
                <div class="toolbar">
                    <div class="inventory-controls">
                        <div class="search-wrapper">
                            <input type="text" x-model="filters.search" placeholder="Buscar por Nombre, N√∫mero, Tipo...">
                            <button class="btn-mic" :class="{'listening': isListening}" @click="toggleVoice">üé§</button>
                        </div>
                        
                        <div class="energy-filter-group">
                            <button class="btn-energy-filter" :class="{'active': !filters.energy}" @click="filters.energy = ''" title="Ver Todos">‚ôæÔ∏è</button>
                            <button class="btn-energy-filter" :class="{'active': filters.energy === 'Planta'}" @click="filters.energy = filters.energy === 'Planta' ? '' : 'Planta'"><img :src="mediaManager.loadEnergyIcon('Planta', TYPE_MAP)"></button>
                            <button class="btn-energy-filter" :class="{'active': filters.energy === 'Fuego'}" @click="filters.energy = filters.energy === 'Fuego' ? '' : 'Fuego'"><img :src="mediaManager.loadEnergyIcon('Fuego', TYPE_MAP)"></button>
                            <button class="btn-energy-filter" :class="{'active': filters.energy === 'Agua'}" @click="filters.energy = filters.energy === 'Agua' ? '' : 'Agua'"><img :src="mediaManager.loadEnergyIcon('Agua', TYPE_MAP)"></button>
                            <button class="btn-energy-filter" :class="{'active': filters.energy === 'Electrico'}" @click="filters.energy = filters.energy === 'Electrico' ? '' : 'Electrico'"><img :src="mediaManager.loadEnergyIcon('Electrico', TYPE_MAP)"></button>
                            <button class="btn-energy-filter" :class="{'active': filters.energy === 'Ps√≠quico'}" @click="filters.energy = filters.energy === 'Ps√≠quico' ? '' : 'Ps√≠quico'"><img :src="mediaManager.loadEnergyIcon('Ps√≠quico', TYPE_MAP)"></button>
                            <button class="btn-energy-filter" :class="{'active': filters.energy === 'Lucha'}" @click="filters.energy = filters.energy === 'Lucha' ? '' : 'Lucha'"><img :src="mediaManager.loadEnergyIcon('Lucha', TYPE_MAP)"></button>
                            <button class="btn-energy-filter" :class="{'active': filters.energy === 'Oscuro'}" @click="filters.energy = filters.energy === 'Oscuro' ? '' : 'Oscuro'"><img :src="mediaManager.loadEnergyIcon('Oscuro', TYPE_MAP)"></button>
                            <button class="btn-energy-filter" :class="{'active': filters.energy === 'Acero'}" @click="filters.energy = filters.energy === 'Acero' ? '' : 'Acero'"><img :src="mediaManager.loadEnergyIcon('Acero', TYPE_MAP)"></button>
                            <button class="btn-energy-filter" :class="{'active': filters.energy === 'Dragon'}" @click="filters.energy = filters.energy === 'Dragon' ? '' : 'Dragon'"><img :src="mediaManager.loadEnergyIcon('Dragon', TYPE_MAP)"></button>
                            <button class="btn-energy-filter" :class="{'active': filters.energy === 'Incoloro'}" @click="filters.energy = filters.energy === 'Incoloro' ? '' : 'Incoloro'"><img :src="mediaManager.loadEnergyIcon('Incoloro', TYPE_MAP)"></button>
                        </div>

                        <div class="mobile-controls-grid">
                            <button @click="hideOwned = !hideOwned" class="btn-outline" :style="hideOwned ? 'background:var(--accent-primary); color:var(--bg-main);' : ''">
                                <span x-text="hideOwned ? 'üëÅÔ∏è Faltantes' : 'üëÅÔ∏è Todo'"></span>
                            </button>

                            <select x-model="filters.rarity" class="image-ready-select">
                                <template x-for="opt in rarityOptions" :key="opt.val"><option :value="opt.val" x-text="opt.label"></option></template>
                            </select>

                            <select x-model="filters.sortBy" class="image-ready-select">
                                <option value="id_asc">üî¢ N¬∫</option>
                                <option value="name_asc">üî§ Nombre</option>
                                <option value="owned_desc">üî¢ Cantidad</option>
                            </select>

                            <button @click="bulkMode = !bulkMode" class="btn-outline" x-text="bulkMode?'‚úèÔ∏è Edici√≥n':'üëÅÔ∏è Vista'"></button>
                            
                            <div style="display:flex; align-items:center; justify-content:center; font-size:0.95em; font-weight:bold; color:var(--text-muted); background:var(--bg-input); border:1px solid var(--border-color); border-radius:12px; padding:0 25px; height:50px; min-width: 120px;">
                                <span x-text="saveStatus" :style="saveStatus.includes('Error') ? 'color:var(--danger)' : (saveStatus.includes('Guardando') ? 'color:var(--accent-primary)' : 'color:var(--success)')"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="cards-grid" x-show="!bulkMode" :class="{'compact-mode': compactMode}">
                    <template x-for="(card, index) in filteredCards" :key="card.id_carta+card.expansion">
                        <div class="tcg-card" :class="{'owned': card.cantidad > 0, 'just-updated': card.justUpdated}" @contextmenu="openContextMenu($event, card)" @click="openModal(card)">
                            <div class="new-badge" x-show="isNew(card.fecha_obtencion)">NUEVO</div>
                            
                            <button class="icon-heart-overlay" :class="{'active': card.deseada}" @click.stop="toggleHeart(card)">‚ô•</button>
                            
                            <div class="card-frame">
                                <img :src="mediaManager.loadImage(card)" @error="mediaManager.fallbackImage" loading="lazy" :class="{'grayscale': !card.desbloqueada}">
                            </div>
                            
                            <div class="card-info" x-show="!compactMode">
                                <div class="card-name" x-text="card.nombre" :title="card.nombre"></div>
                                <div class="card-meta"><span x-text="card.id_carta"></span> ‚Ä¢ <span x-text="card.rareza"></span></div>
                            </div>
                            
                            <div class="card-controls" @click.stop>
                                <button class="btn-mini-overlay" @click.stop="updateQty(card, -1)" :disabled="readOnly || card.cantidad <= 0">-</button>
                                <span class="qty-display" x-text="card.cantidad" :style="card.cantidad > 0 ? 'color:var(--text-light)' : 'color:var(--text-muted)'"></span>
                                <button class="btn-mini-overlay" @click.stop="updateQty(card, 1)" :disabled="readOnly">+</button>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="bulk-table-container" x-show="bulkMode">
                    <table class="bulk-table">
                        <thead>
                            <tr>
                                <th>Carta</th>
                                <th>Rareza</th>
                                <th style="text-align:right">Cantidad</th>
                                <th style="text-align:center">Favorito</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="card in filteredCards" :key="card.id_carta+card.expansion">
                                <tr :class="{'owned': card.cantidad > 0}">
                                    <td>
                                        <img :src="mediaManager.loadImage(card)" class="bulk-card-img" loading="lazy">
                                        <div style="font-weight:bold;" x-text="card.nombre"></div>
                                    </td>
                                    <td x-text="card.rareza" style="color:var(--text-muted);"></td>
                                    <td style="text-align:right">
                                        <input type="number" x-model.number="card.cantidad" min="0" class="qty-input" :disabled="readOnly" @change="triggerAutoSave()">
                                    </td>
                                    <td style="text-align:center">
                                        <button class="icon-heart-overlay" style="position:static; width:35px; height:35px; font-size:1.2rem; margin:0 auto;" :class="{'active': card.deseada}" @click="toggleHeart(card)">‚ô•</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <div x-show="tab==='social'" class="tab-pane fade-in-up">
                
                <div style="position: sticky; top: 0; z-index: 50; background: var(--bg-main); padding: 15px 0;">
                    <input type="text" class="social-search-bar" x-model="socialSearch" placeholder="üïµÔ∏è Buscar jugador, carta o rareza...">
                    <div class="filter-scroll-container">
                        <select x-model="socialFilters.rarity" class="filter-select"><option value="TODAS">üíé Rareza: Todas</option><template x-for="opt in allRarityOptions.filter(o=>o.val!=='TODAS')"><option :value="opt.val" x-text="opt.label"></option></template></select>
                        <select x-model="socialFilters.expansion" class="filter-select"><option value="TODAS">üìÇ Exp: Todas</option><template x-for="e in expansiones"><option :value="e" x-text="e"></option></template></select>
                        <div class="filter-chip" :class="{'active': socialFilters.onlyFav}" @click="socialFilters.onlyFav = !socialFilters.onlyFav">‚ù§Ô∏è Wishlist</div>
                        <div class="filter-chip" @click="socialFilters.rarity='TODAS'; socialFilters.expansion='TODAS'; socialFilters.onlyFav=false">‚úñ Limpiar</div>
                    </div>
                </div>

                <div class="mobile-social-tabs" x-show="windowWidth < 768 && currentUser.nombre !== 'Dinama20'">
                    <button class="mob-tab-btn" 
                            :class="{ 'active': socialMobileTab === 'gifts' }" 
                            @click="socialMobileTab = 'gifts'">
                        üéÅ Centro de Regalos
                    </button>
                    <button class="mob-tab-btn" 
                            :class="{ 'active': socialMobileTab === 'trades' }" 
                            @click="socialMobileTab = 'trades'">
                        üîÑ Mercado Global
                    </button>
                </div>

                <div class="social-split-view" :style="currentUser.nombre === 'Dinama20' ? 'grid-template-columns: 1fr;' : ''">
                    
                    <div class="social-column" x-show="currentUser.nombre !== 'Dinama20'" :class="{ 'hidden-on-mobile': socialMobileTab !== 'gifts' }">
                        <div class="column-header">
                            üéÅ Centro de Regalos 
                            <span class="badge" style="background:var(--accent-primary); color:black; font-size:0.7rem; padding:2px 6px; border-radius:4px;" x-text="filteredSocialItems.shares.length"></span>
                        </div>
                        
                        <div class="social-column-scroll" @scroll="handleVirtualScroll('SHARE', $event)">
                            <div :style="`height: ${virtualSharesData.totalHeight}px; position: relative; overflow: hidden;`">
                                <div :style="`transform: translateY(${virtualSharesData.offsetY}px);`">
                                    <div class="gift-grid">
                                        <template x-for="item in virtualSharesData.items" :key="item.card.id_carta + item.targetUser.id">
                                            <div class="gift-ticket">
                                                <div class="gift-img-container">
                                                    <img :src="mediaManager.loadImage(item.card)" class="gift-img">
                                                    <div style="position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.8); color:white; font-size:0.6rem; padding:3px; text-align:center;">
                                                        Para: <b x-text="item.targetUser.name"></b>
                                                    </div>
                                                </div>
                                                <div class="gift-info">
                                                    <div class="gift-name" x-text="item.card.nombre"></div>
                                                    <button class="gift-btn" @click="visualGiftEffect($el, item)">ENVIAR</button>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            <div x-show="filteredSocialItems.shares.length === 0" style="text-align:center; padding:30px; color:var(--text-muted); font-style:italic;">
                                No tienes cartas sobrantes para regalar hoy.
                            </div>
                        </div>
                    </div>

                    <div class="social-column" :class="{ 'hidden-on-mobile': socialMobileTab !== 'trades' }">
                        <div class="column-header">
                            üîÑ Mercado Global 
                            <span class="badge" style="background:var(--text-light); color:black; font-size:0.7rem; padding:2px 6px; border-radius:4px;" x-text="filteredSocialItems.trades.length"></span>
                        </div>
                        
                        <div class="social-column-scroll" @scroll="handleVirtualScroll('TRADE', $event)">
                            <div :style="`height: ${virtualTradesData.totalHeight}px; position: relative; overflow: hidden;`">
                                <div :style="`transform: translateY(${virtualTradesData.offsetY}px);`">
                                    <div class="trade-list">
                                        <template x-for="trade in virtualTradesData.items" :key="trade.give.id_carta + trade.get.id_carta + trade.partner.id">
                                            <div class="trade-capsule biome-base" 
                                                 :class="[getBiomeClass(trade.get.tipo), {'is-poor': currentUser.polvos_iris < trade.cost, 'win-win': trade.get.deseada && isSetCompleter(trade.get)}]">
                                                
                                                <div class="win-badge" x-show="trade.get.deseada && isSetCompleter(trade.get)">WIN-WIN</div>

                                                <div class="capsule-left">
                                                    <div style="font-size:0.6rem; color:#00ff88; font-weight:900; margin-bottom:5px;">RECIBES</div>
                                                    <div class="card-tilt-wrapper">
                                                        <div class="card-aura-box" :class="getAuraClass(trade.get.rareza)">
                                                            <img :src="mediaManager.loadImage(trade.get)" class="trade-img" style="width:60px;">
                                                            <div class="set-completer-icon" x-show="isSetCompleter(trade.get)">üß©</div>
                                                        </div>
                                                    </div>
                                                    <div style="font-size:0.7rem; margin-top:5px; font-weight:bold;" x-text="trade.get.nombre"></div>
                                                    <div class="partner-info">
                                                        <div class="partner-avatar" :style="`background-image:url(${trade.partner.avatar})`"></div>
                                                        <span class="partner-name" x-text="trade.partner.name"></span>
                                                    </div>
                                                </div>

                                                <div class="capsule-mid">
                                                    <button class="hold-btn" 
                                                            :disabled="currentUser.polvos_iris < trade.cost"
                                                            @mousedown="startHold(trade, null, $el)" 
                                                            @mouseup="cancelHold" 
                                                            @mouseleave="cancelHold" 
                                                            @touchstart.prevent="startHold(trade, null, $el)" 
                                                            @touchend="cancelHold">
                                                        <div class="hold-fill" :style="`width: ${holdingTrade === trade ? holdProgress : 0}%`"></div>
                                                        <div class="hold-content">
                                                            <span class="price-val" x-text="trade.cost"></span>
                                                            <span class="price-lbl">HOLD</span>
                                                        </div>
                                                    </button>
                                                </div>

                                                <div class="capsule-right">
                                                    <div style="font-size:0.6rem; color:#ff3366; font-weight:900; margin-bottom:5px;">DAS</div>
                                                    <div class="card-tilt-wrapper">
                                                        <div class="card-aura-box" :class="getAuraClass(trade.give.rareza)">
                                                            <img :src="mediaManager.loadImage(trade.give)" class="trade-img" style="width:60px;">
                                                            <div class="qty-badge qty-give" x-text="'x'+trade.give.cantidad"></div>
                                                        </div>
                                                    </div>
                                                    <div style="font-size:0.7rem; margin-top:5px;" x-text="trade.give.nombre"></div>
                                                </div>

                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            <div x-show="filteredSocialItems.trades.length === 0" style="text-align:center; padding:30px; color:var(--text-muted); font-style:italic;">
                                No hay intercambios disponibles que coincidan con tus cartas faltantes.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="social-footer visible">
                    <div class="res-pill">
                        <span style="font-size:1.4rem;">üåà</span> <span x-text="currentUser.polvos_iris"></span>
                    </div>
                    <div class="res-pill">
                        <span style="font-size:1.4rem;">üé´</span> <span x-text="currentUser.fichas_cambio"></span>
                    </div>
                </div>
            </div>

            <div x-show="tab==='history'" class="tab-pane fade-in-up">
                <div class="card-panel">
                    <h3>üìú Historial de Movimientos</h3>
                    <div class="history-timeline">
                        <template x-for="h in history" :key="h.id_trans">
                            <div class="history-card" :class="getHistoryClass(h)">
                                <div class="history-info">
                                    <div class="history-date" x-text="new Date(h.fecha).toLocaleString()"></div>
                                    <div class="history-title" x-text="h.carta_nombre"></div>
                                    <div class="history-reason" x-text="h.motivo"></div>
                                </div>
                                <div class="history-change">
                                    <span :class="h.cantidad_nueva > h.cantidad_anterior ? 'change-plus' : 'change-minus'">
                                        <span x-text="h.cantidad_anterior"></span> ‚ûî <span x-text="h.cantidad_nueva"></span>
                                    </span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <div x-show="tab==='admin' && isAdmin" class="tab-pane fade-in-up">
                
                <div class="card-panel" style="margin-top: 30px;">
                    <h3>üõ†Ô∏è Mantenimiento Avanzado</h3>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <button class="btn-outline" @click="syncWiki">üîÑ Sincronizar Wiki</button>
                        <button class="btn-danger" @click="forceReset">‚è∞ Forzar Reset Diario (7:00 AM)</button>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom:20px;">
                        <button class="btn-outline" @click="fullDbBackup">‚¨áÔ∏è Exportar DB</button>
                        <div style="position: relative;">
                            <input type="file" id="dbImportInput" style="position:absolute; opacity:0; width:100%; height:100%; cursor:pointer;" @change="fullDbRestore($event)">
                            <button class="btn-outline" style="width:100%;">‚¨ÜÔ∏è Importar Base de Datos</button>
                        </div>
                    </div>
                    
                    <button class="btn-danger" style="width:100%" @click="adminCleanDB">üßπ LIMPIAR DB (FUSIONAR DUPLICADOS)</button>
                </div>

                <div class="card-panel">
                    <h3>‚ö° Gestor de Intercambios & Regalos (Admin)</h3>
                    <div class="admin-trade-container">
                        <div class="admin-trade-side">
                            <h4 style="color:var(--accent-primary); margin-bottom:20px;">JUGADOR A</h4>
                            <div class="user-selector-row">
                                <div class="admin-avatar" :style="adminTrade.userA ? `background-image:url(${getAvatar(adminTrade.userA)})` : ''"></div>
                                <select x-model="adminTrade.userA" @change="loadAdminUserInventory($event.target.value, 'A')" style="flex:1">
                                    <option value="">Seleccionar...</option>
                                    <template x-for="acc in accounts"><option :value="acc.id_cuenta" x-text="acc.nombre"></option></template>
                                </select>
                            </div>
                            
                            <div style="display:flex; gap:5px; margin-bottom:10px; margin-top:15px;">
                                <select id="admin-filter-rarity" onchange="filterAdminCards()" style="flex:1; padding:8px; border-radius:5px; background:#333; color:white; border:1px solid #555;">
                                    <option value="ALL">Todas Rarezas</option>
                                    <option value="1 Rombo">‚ô¶</option>
                                    <option value="2 Rombos">‚ô¶‚ô¶</option>
                                    <option value="3 Rombos">‚ô¶‚ô¶‚ô¶</option>
                                    <option value="4 Rombos">‚ô¶‚ô¶‚ô¶‚ô¶</option>
                                    <option value="1 Estrella">‚≠ê</option>
                                    <option value="2 Estrellas">‚≠ê‚≠ê</option>
                                    <option value="Corona">üëë</option>
                                </select>
                                <select id="admin-filter-exp" onchange="filterAdminCards()" style="flex:1; padding:8px; border-radius:5px; background:#333; color:white; border:1px solid #555;">
                                    <option value="ALL">Todas Exp.</option>
                                    <option value="genes formidables">A1</option>
                                    <option value="isla singular">A1a</option>
                                    <option value="pugna">A2</option>
                                </select>
                            </div>

                            <div class="card-picker-area" x-show="adminTrade.userA">
                                <input type="text" x-model="adminTrade.searchA" class="admin-search-input" placeholder="Buscar..." @input="filterAdminInventory('A')">
                                <select id="admin-card-select" style="display:none;"></select> 
                                
                                <div class="results-dropdown" x-show="adminUserAInventoryFiltered.length > 0" style="max-height:200px; overflow-y:auto; border:1px solid var(--border-color); background:var(--bg-panel); z-index:100; position:relative;">
                                    <template x-for="c in adminUserAInventoryFiltered">
                                        <div class="result-item" @click="selectAdminCard(c, 'A')" style="display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid rgba(255,255,255,0.05);">
                                            <img :src="mediaManager.loadImage(c)" style="width:40px; border-radius:4px;">
                                            <div style="text-align:left; flex:1;">
                                                <div x-text="c.nombre" style="font-weight:bold; font-size:0.9rem;"></div>
                                                <div style="font-size:0.75rem; color:var(--text-muted);">
                                                    <span x-text="'Cant: ' + c.cantidad"></span> ‚Ä¢ <span x-text="c.expansion"></span>
                                                </div>
                                            </div>
                                            <div style="font-size:0.7rem; color:var(--gold); font-weight:bold;" x-text="c.rareza"></div>
                                            <span style="display:none;" x-text="c.rareza + ' ' + c.expansion"></span>
                                        </div>
                                    </template>
                                </div>
                                <template x-if="adminTrade.cardA">
                                    <div style="margin-top:15px; background:rgba(0,0,0,0.3); padding:15px; border-radius:12px; text-align:center;">
                                        <img :src="mediaManager.loadImage(adminTrade.cardA)" class="selected-card-preview" style="margin:0 auto 10px; max-width:120px; display:block;">
                                        <div style="font-weight:900; color:var(--text-light); font-size:1.1rem;" x-text="adminTrade.cardA.nombre"></div>
                                        <div style="font-size:0.8rem; color:var(--accent-primary); margin:5px 0;" x-text="adminTrade.cardA.expansion"></div>
                                        <div style="background:rgba(255,255,255,0.1); display:inline-block; padding:2px 8px; border-radius:4px; font-size:0.75rem; font-family:var(--font-mono);" x-text="adminTrade.cardA.id_carta"></div>
                                        <div style="font-size:0.85rem; color:var(--gold); margin-top:8px; font-weight:bold;" x-text="adminTrade.cardA.rareza"></div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div class="admin-trade-mid">
                            <div class="admin-arrow">‚áÑ</div>
                            <button class="btn-save" @click="executeAdminTrade" :disabled="!adminTrade.cardA || !adminTrade.cardB">Forzar Intercambio</button>
                            <button class="btn-outline" @click="executeAdminGift" :disabled="!adminTrade.cardA || !adminTrade.userB">Forzar Regalo</button>
                            
                            <div x-show="adminTrade.cardA && adminTrade.cardB" class="trade-cost-display" style="margin-top:15px;">
                                <span style="color:var(--text-muted); font-size:0.8rem;">COSTE ESTIMADO</span>
                                <span class="cost-value" x-text="getTradeCost(adminTrade.cardA?.rareza) + ' Polvos'"></span>
                            </div>
                        </div>

                        <div class="admin-trade-side">
                            <h4 style="color:var(--success); margin-bottom:20px;">JUGADOR B</h4>
                            <div class="user-selector-row">
                                <div class="admin-avatar" :style="adminTrade.userB ? `background-image:url(${getAvatar(adminTrade.userB)})` : ''"></div>
                                <select x-model="adminTrade.userB" @change="loadAdminUserInventory($event.target.value, 'B')" style="flex:1">
                                    <option value="">Seleccionar...</option>
                                    <template x-for="acc in accounts"><option :value="acc.id_cuenta" x-text="acc.nombre"></option></template>
                                </select>
                            </div>
                            <div class="card-picker-area" x-show="adminTrade.userB">
                                <input type="text" x-model="adminTrade.searchB" class="admin-search-input" placeholder="Buscar..." @input="filterAdminInventory('B')">
                                <div class="results-dropdown" x-show="adminUserBInventoryFiltered.length > 0" style="max-height:200px; overflow-y:auto; border:1px solid var(--border-color); background:var(--bg-panel); z-index:100; position:relative;">
                                    <template x-for="c in adminUserBInventoryFiltered">
                                        <div class="result-item" @click="selectAdminCard(c, 'B')" style="display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid rgba(255,255,255,0.05);">
                                            <img :src="mediaManager.loadImage(c)" style="width:40px; border-radius:4px;">
                                            <div style="text-align:left; flex:1;">
                                                <div x-text="c.nombre" style="font-weight:bold; font-size:0.9rem;"></div>
                                                <div style="font-size:0.75rem; color:var(--text-muted);">
                                                    <span x-text="'Cant: ' + c.cantidad"></span> ‚Ä¢ <span x-text="c.expansion"></span>
                                                </div>
                                            </div>
                                            <div style="font-size:0.7rem; color:var(--gold); font-weight:bold;" x-text="c.rareza"></div>
                                        </div>
                                    </template>
                                </div>
                                <template x-if="adminTrade.cardB">
                                    <div style="margin-top:15px; background:rgba(0,0,0,0.3); padding:15px; border-radius:12px; text-align:center;">
                                        <img :src="mediaManager.loadImage(adminTrade.cardB)" class="selected-card-preview" style="margin:0 auto 10px; max-width:120px; display:block;">
                                        <div style="font-weight:900; color:var(--text-light); font-size:1.1rem;" x-text="adminTrade.cardB.nombre"></div>
                                        <div style="font-size:0.8rem; color:var(--accent-primary); margin:5px 0;" x-text="adminTrade.cardB.expansion"></div>
                                        <div style="background:rgba(255,255,255,0.1); display:inline-block; padding:2px 8px; border-radius:4px; font-size:0.75rem; font-family:var(--font-mono);" x-text="adminTrade.cardB.id_carta"></div>
                                        <div style="font-size:0.85rem; color:var(--gold); margin-top:8px; font-weight:bold;" x-text="adminTrade.cardB.rareza"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-panel">
                    <h3>üì¶ Inyector de Sobres</h3>
                    <div style="display:flex; gap:20px; margin-bottom:30px;">
                        <select x-model="adminPack.targetUser" style="flex:2"><template x-for="acc in accounts"><option :value="acc.id_cuenta" x-text="acc.nombre"></option></template></select>
                        <select x-model="packSimulator.expansion" style="flex:1" @change="updatePackConfig"><template x-for="e in expansiones"><option :value="e" x-text="e"></option></template></select>
                    </div>
                    
                    <div style="text-align:right; margin-bottom:10px;" x-show="!packSimulator.expansion.toLowerCase().includes('deluxe')">
                        <button class="btn-outline" style="height:30px; font-size:0.8rem; padding:0 15px;" 
                                @click="packSimulator.activeCount = packSimulator.activeCount === 5 ? 6 : 5">
                            <span x-text="packSimulator.activeCount === 6 ? '‚ûñ Quitar 6¬™ Carta' : '‚ûï A√±adir 6¬™ Carta'"></span>
                        </button>
                    </div>

                    <div class="injector-grid">
                        <template x-for="(slot, i) in packSimulator.slots" :key="i">
                            <div class="injector-slot" x-show="i < packSimulator.activeCount">
                                <template x-if="!slot">
                                    <div style="position:relative; width:100%;">
                                        <input type="text" x-model="packSimulator.queries[i]" @input="searchCardForPack(i)" placeholder="Buscar..." style="width:100%;">
                                        <div x-show="packSimulator.searchResults[i].length > 0" class="results-dropdown" style="position:absolute; top:100%; left:0; width:100%; background:var(--bg-panel); z-index:100; max-height:200px; overflow-y:auto; border:1px solid var(--border-color);">
                                            <template x-for="res in packSimulator.searchResults[i]">
                                                <div @click="selectCardForSlot(i, res)" style="padding:10px; cursor:pointer; display:flex; align-items:center; gap:10px; border-bottom:1px solid rgba(255,255,255,0.1);">
                                                    <img :src="mediaManager.loadImage(res)" style="width:40px; border-radius:4px;">
                                                    <div style="text-align:left;">
                                                        <div x-text="res.nombre" style="font-weight:bold; font-size:0.9rem;"></div>
                                                        <div style="font-size:0.75rem; color:var(--text-muted);">
                                                            <span x-text="res.id_carta"></span> ‚Ä¢ <span x-text="res.expansion"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="slot">
                                    <div @click="clearSlot(i)" style="cursor:pointer;"><img :src="mediaManager.loadImage(slot)" width="100%"></div>
                                </template>
                            </div>
                        </template>
                    </div>
                    <button class="btn-save" style="width:100%" @click="executePackOpening">‚ö° ABRIR SOBRE AHORA</button>
                </div>
                
                <div class="card-panel">
                    <h3>üë• Gesti√≥n de Usuarios</h3>
                    <div class="bulk-table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Tipo</th>
                                    <th>Prio</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="u in accounts" :key="u.id_cuenta">
                                    <tr>
                                        <td x-text="u.id_cuenta"></td>
                                        <td x-text="u.nombre"></td>
                                        <td>
                                            <select x-model="u.tipo" @change="adminUpdateUser(u)" style="background:rgba(0,0,0,0.3); border:none; color:white; padding:5px;">
                                                <option value="Principal">Principal</option>
                                                <option value="Secundaria">Secundaria</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" x-model.number="u.prioridad" @change="adminUpdateUser(u)" style="width:60px; text-align:center; background:rgba(0,0,0,0.3); border:none; color:white;">
                                        </td>
                                        <td>
                                            <button class="btn-danger" style="padding:5px 10px; font-size:0.8rem;" @click="adminDeleteUser(u.id_cuenta)">üóëÔ∏è</button>
                                            <button class="btn-outline" style="padding:5px 10px; font-size:0.8rem;" @click="adminResetPass(u.id_cuenta)">üîë</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <button class="btn-outline" style="width:100%; margin-top:25px;" @click="openCreateUserModal()">+ Registrar Nuevo Usuario</button>
                </div>
            </div>
        </main>
        
        <div class="modal-overlay" x-show="modalCard" x-cloak @click.self="closeModal" x-transition.opacity>
            <div class="card-3d-container">
                <div class="tcg-card-wrapper">
                    <div class="tcg-card-3d owned" style="border:none;">
                        <img :src="mediaManager.loadImage(modalCard)" @error="mediaManager.fallbackImage" style="width:100%; border-radius:20px;">
                    </div>
                    <div style="text-align:center; margin-top:20px;">
                        <h2 x-text="modalCard?.nombre" style="color:white; margin-bottom:10px;"></h2>
                        <div style="display:flex; gap:10px; justify-content:center;">
                            <button class="btn-save" @click="updateQty(modalCard, 1)">+1 A√±adir</button>
                            <button class="btn-outline" @click="toggleHeart(modalCard)">‚ù§Ô∏è</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-overlay" x-show="showSettings" x-cloak x-transition.opacity>
            <div class="settings-modal" @click.outside="showSettings = false">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom:1px solid var(--border-color); padding-bottom:20px;">
                    <h2 class="text-xl font-bold text-neon-blue">Configuraci√≥n</h2>
                    <button @click="showSettings = false" class="text-gray-400 hover:text-white" style="font-size:1.5rem;">‚úï</button>
                </div>

                <div class="flex border-b border-gray-700 mb-4" style="display:flex; border-bottom:1px solid #4b5563; margin-bottom:1rem;">
                    <button @click="settingsTab = 'profile'" :class="{'border-b-2 border-neon-blue text-white': settingsTab==='profile'}" style="flex:1; padding:0.75rem; color:#9ca3af; transition:all 0.2s;" class="hover:text-white">üë§ Perfil</button>
                    <button @click="settingsTab = 'data'" :class="{'border-b-2 border-neon-blue text-white': settingsTab==='data'}" style="flex:1; padding:0.75rem; color:#9ca3af; transition:all 0.2s;" class="hover:text-white">üíæ Datos</button>
                    <button @click="settingsTab = 'view'" :class="{'border-b-2 border-neon-blue text-white': settingsTab==='view'}" style="flex:1; padding:0.75rem; color:#9ca3af; transition:all 0.2s;" class="hover:text-white">üëÅÔ∏è Visual</button>
                </div>

                <div x-show="settingsTab === 'profile'">
                    <label style="display:block; margin-bottom:15px; color:var(--text-muted); font-weight:800; font-size:0.9rem; text-transform:uppercase;">Avatar Personalizado</label>
                    <div style="display:flex; gap:25px; align-items:center; margin-bottom:25px;">
                        <div class="avatar-circle" :style="settingsForm.avatar ? `background-image:url(${settingsForm.avatar});` : ''" style="width:90px; height:90px; font-size:2.5rem; flex-shrink:0; border:3px solid var(--accent-primary); box-shadow:0 0 25px var(--accent-glow);"><span x-show="!settingsForm.avatar">üë§</span></div>
                        <input type="file" accept="image/*" @change="handleAvatarUpload" style="padding:15px; border:2px dashed var(--border-color); background:transparent;">
                    </div>
                    <button class="btn-save" @click="saveSettingsProfile" style="width:100%; margin-bottom:20px;">Guardar Nuevo Avatar</button>
                    
                    <div style="border-top:1px solid var(--border-color); padding-top:20px; margin-top:20px;">
                        <h4 style="margin-bottom:15px;">Cambiar Contrase√±a</h4>
                        <input type="password" x-model="settingsForm.passOld" placeholder="Contrase√±a Actual" class="social-search-bar" style="margin-bottom:10px;">
                        <input type="password" x-model="settingsForm.passNew" placeholder="Nueva Contrase√±a" class="social-search-bar">
                        <button class="btn-outline" @click="changePassword" style="width:100%; margin-top:10px;">Actualizar Clave</button>
                    </div>
                </div>

                <div x-show="settingsTab === 'data'">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
                        <button class="btn-outline" @click="exportCollection" style="height:80px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                            <span style="font-size:1.5rem;">üì•</span>
                            <span>Exportar CSV</span>
                        </button>
                        <button class="btn-outline" @click="runAutoWishlist" style="height:80px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                            <span style="font-size:1.5rem;">‚ù§Ô∏è</span>
                            <span>Auto-Wishlist</span>
                        </button>
                    </div>
                    
                    <label style="display:block; margin-bottom:10px; color:var(--text-muted); font-weight:bold;">Importar Inventario (.csv)</label>
                    <div style="background:var(--bg-input); padding:20px; border-radius:12px; border:2px dashed var(--border-color); text-align:center;">
                        <input type="file" accept=".csv" @change="handleCSVSelect" style="width:100%; color:var(--text-light);">
                        <p style="font-size:0.75rem; color:var(--text-muted); margin-top:10px;">Formato: Nombre, Expansi√≥n, Cantidad</p>
                    </div>
                    <button class="btn-save" @click="processCSVUpload" style="width:100%; margin-top:15px;" :disabled="!csvFileContent">
                        Procesar Archivo CSV
                    </button>
                </div>

                <div x-show="settingsTab === 'view'">
                    <label style="display:block; margin-bottom:15px; color:var(--text-muted); font-weight:800; font-size:0.9rem; text-transform:uppercase;">Tema Visual</label>
                    <select x-model="currentTheme" style="width:100%; margin-bottom:20px; padding:10px; background:var(--bg-input); color:white; border:1px solid var(--border-color); border-radius:8px;">
                        <option value="neon">üü£ Ne√≥n (Dark Mode)</option>
                        <option value="light">‚òÄÔ∏è D√≠a (Light Mode)</option>
                        <option value="fuego">üî• Fuego (Intense)</option>
                        <option value="agua">üíß Agua (Deep Sea)</option>
                        <option value="gameboy">üëæ GameBoy (Retro)</option>
                    </select>
                    
                    <div style="margin-bottom: 20px;">
                        <span style="font-weight:bold; color:var(--text-light); display:block; margin-bottom:5px;">üì± Modo Compacto</span>
                        <div class="toggle-pill" style="width: 100%; display:flex; background: var(--bg-input); border-radius: 999px; padding: 4px; border: 1px solid var(--border-color);">
                            <div class="toggle-option" style="flex:1; text-align:center; padding: 10px; border-radius: 999px; cursor: pointer; transition: all 0.2s;" 
                                 :class="{'active': !compactMode}" 
                                 :style="!compactMode ? 'background: var(--accent-primary); color: #000; font-weight:bold;' : 'color: var(--text-muted);'"
                                 @click="compactMode = false; localStorage.setItem('compactMode', 'false')">OFF</div>
                            <div class="toggle-option" style="flex:1; text-align:center; padding: 10px; border-radius: 999px; cursor: pointer; transition: all 0.2s;" 
                                 :class="{'active': compactMode}" 
                                 :style="compactMode ? 'background: var(--accent-primary); color: #000; font-weight:bold;' : 'color: var(--text-muted);'"
                                 @click="compactMode = true; localStorage.setItem('compactMode', 'true')">ON</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <span style="font-weight:bold; color:var(--text-light); display:block; margin-bottom:5px;">‚ö° Modo Bajo Consumo</span>
                        <div class="toggle-pill" style="width: 100%; display:flex; background: var(--bg-input); border-radius: 999px; padding: 4px; border: 1px solid var(--border-color);">
                            <div class="toggle-option" style="flex:1; text-align:center; padding: 10px; border-radius: 999px; cursor: pointer; transition: all 0.2s;" 
                                 :class="{'active': !lowPowerMode}" 
                                 :style="!lowPowerMode ? 'background: var(--accent-primary); color: #000; font-weight:bold;' : 'color: var(--text-muted);'"
                                 @click="lowPowerMode = false; localStorage.setItem('lowPowerMode', 'false')">OFF</div>
                            <div class="toggle-option" style="flex:1; text-align:center; padding: 10px; border-radius: 999px; cursor: pointer; transition: all 0.2s;" 
                                 :class="{'active': lowPowerMode}" 
                                 :style="lowPowerMode ? 'background: var(--accent-primary); color: #000; font-weight:bold;' : 'color: var(--text-muted);'"
                                 @click="lowPowerMode = true; localStorage.setItem('lowPowerMode', 'true'); showToast('3D OFF', 'info')">ON</div>
                        </div>
                    </div>

                    <div style="margin-top:25px; padding-top: 1rem; border-top:1px solid var(--border-color); text-align:right;">
                        <button class="btn-save" @click="saveSettingsProfile">Guardar Cambios</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-overlay" x-show="adminUserForm.visible" x-cloak x-transition.opacity>
            <div class="settings-modal" style="width:500px;" @click.outside="adminUserForm.visible = false">
                <h3 style="color:var(--accent-primary);">Registrar Nuevo Usuario</h3>
                <input type="text" x-model="adminUserForm.name" placeholder="Nombre de usuario..." style="margin-bottom:25px; padding:20px; font-size:1.2rem; width:100%; background:var(--bg-input); border:1px solid var(--border-color); color:white;">
                <div style="display:flex; gap:15px;">
                    <button class="btn-outline" @click="adminUserForm.visible = false" style="flex:1">Cancelar</button>
                    <button class="btn-save" @click="adminCreateUser" style="flex:1">Confirmar</button>
                </div>
            </div>
        </div>

        <div style="position:fixed; top:30px; right:30px; z-index:11000; pointer-events:none; display:flex; flex-direction:column; gap:10px;">
            <template x-for="t in toasts" :key="t.id"><div class="toast" :class="t.type" x-text="t.msg" x-transition.opacity.duration.300ms style="pointer-events: auto;"></div></template>
        </div>

        <div class="context-menu" x-show="contextMenu.visible" :style="`top: ${contextMenu.y}px; left: ${contextMenu.x}px`" @click.stop x-transition>
            <div class="context-item" @click="updateQty(contextMenu.card, 1); closeContextMenu()">‚ûï A√±adir copia (+1)</div>
            <div class="context-item" @click="contextMenu.card.desbloqueada = !contextMenu.card.desbloqueada; triggerAutoSave(); closeContextMenu()">
                <span x-text="contextMenu.card.desbloqueada ? 'üìñ Quitar de Pokedex' : 'üìñ Registrar en Pokedex'"></span>
            </div>
            <div class="context-item" @click="toggleHeart(contextMenu.card); closeContextMenu()">
                <span x-text="contextMenu.card?.deseada ? 'üíî Quitar de Favoritos' : '‚ù§Ô∏è A√±adir a Favoritos'"></span>
            </div>
            <div class="context-item" @click="openModal(contextMenu.card); closeContextMenu()">üîç Ver Detalle Grande</div>
        </div>

        <button class="scroll-top" :class="{'visible': showScrollTop}" @click="scrollToTop">‚¨Ü</button>

    </div>
</body>
</html>